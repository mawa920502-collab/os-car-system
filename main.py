import streamlit as st
import pandas as pd
import os
import requests
from bs4 import BeautifulSoup
from datetime import datetime
import webbrowser
import re
from urllib.parse import quote_plus
import time
import shutil

CSV_PATH = "baza.csv"

# ‚úÖ BACKUP DANYCH
def backup_data():
    if os.path.exists(CSV_PATH):
        backup_name = f"backup_baza_{datetime.now().strftime('%Y%m%d_%H%M')}.csv"
        shutil.copy2(CSV_PATH, backup_name)
        return backup_name
    return None

# ‚ö° OPTYMALIZACJA - cache dla danych
@st.cache_data(ttl=300)
def load_data():
    if not os.path.exists(CSV_PATH):
        return pd.DataFrame(columns=["id", "tytul", "cena", "link", "opis", "status", "notatka", "dodano"])
    df = pd.read_csv(CSV_PATH, dtype=str)
    # ‚úÖ USUWANIE 'nan' Z PUSTYCH P√ìL
    df = df.replace('nan', '').fillna('')
    return df

# ‚ö° OPTYMALIZACJA - szybszy zapis
def save_data(df):
    # ‚úÖ USUWANIE 'nan' PRZED ZAPISEM
    df = df.replace('nan', '').fillna('')
    df.to_csv(CSV_PATH, index=False, encoding="utf-8")
    # ‚úÖ TWORZENIE BACKUPU PRZY KA≈ªDYM ZAPISIE
    backup_name = backup_data()
    if backup_name:
        st.toast(f"üìÇ Backup utworzony: {backup_name}", icon="‚úÖ")
    load_data.clear()

def save_field(idx, key, column):
    value = st.session_state.get(key, "")
    current_df = load_data()
    current_df.at[idx, column] = value
    save_data(current_df)

def extract_ids_and_links(html):
    soup = BeautifulSoup(html, "html.parser")
    links = soup.select("a[href*='sprzedajemy.pl/'][href*='nr']")
    ids, urls = [], []
    for link in links:
        href = link.get("href", "")
        if "nr" in href:
            offer_id = href.split("-")[-1].replace("nr", "")
            clean = href.replace("httpshttps", "https").replace("https//", "https://").replace("https://sprzedajemy.plhttps://", "https://sprzedajemy.pl/")
            full_url = "https://sprzedajemy.pl" + href if not href.startswith("https") else clean
            ids.append(offer_id)
            urls.append(full_url)
    return ids, urls

def analyze_search(base):
    headers = {"User-Agent": "Mozilla/5.0"}
    url_title = f"https://oscar.sprzedajemy.pl/szukaj?schm2=ls&catCode=6bea9f&inp_text%5Bv%5D={base}&inp_category_id=2&inp_location_id=1"
    url_id = f"{url_title}&inp_text%5Bn%5D=1"

    # ‚ö° DODAJ TIMEOUT - szybsze b≈Çƒôdy
    try:
        html_title = requests.get(url_title, headers=headers, timeout=8).text
        html_id = requests.get(url_id, headers=headers, timeout=8).text
    except requests.exceptions.Timeout:
        return {"ids_title": [], "urls_title": [], "ids_id": [], "urls_id": [], "url_title": url_title, "url_id": url_id}
    except Exception as e:
        st.error(f"B≈ÇƒÖd po≈ÇƒÖczenia: {e}")
        return {"ids_title": [], "urls_title": [], "ids_id": [], "urls_id": [], "url_title": url_title, "url_id": url_id}
    
    ids_title, urls_title = extract_ids_and_links(html_title)
    ids_id, urls_id = extract_ids_and_links(html_id)

    return {
        "ids_title": ids_title,
        "urls_title": urls_title,
        "ids_id": ids_id,
        "urls_id": urls_id,
        "url_title": url_title,
        "url_id": url_id
    }

def szukaj_allegro_parts_skoda(fraza):
    try:
        encoded_fraza = quote_plus(fraza)
        allegro_url = f"https://allegro.pl/uzytkownik/PARTS_SKODA?string={encoded_fraza}"
        
        return {
            "link": allegro_url,
            "fraza": fraza,
            "platforma": "Allegro",
            "seller": "CZƒò≈öCI_SKODA"
        }
        
    except Exception as e:
        st.error(f"B≈ÇƒÖd Allegro: {str(e)}")
        return None

def search_multiple_platforms(query):
    results = {}
    
    base = query.strip().replace(" ", "+")
    sprzedajemy_result = analyze_search(base)
    results["sprzedajemy"] = sprzedajemy_result
    
    allegro_result = szukaj_allegro_parts_skoda(query)
    results["allegro"] = allegro_result
    
    return results

def get_best_offer_link(results, query):
    sprzedajemy_result = results["sprzedajemy"]
    allegro_result = results["allegro"]
    
    ids_title, urls_title = sprzedajemy_result["ids_title"], sprzedajemy_result["urls_title"]
    ids_id, urls_id = sprzedajemy_result["ids_id"], sprzedajemy_result["urls_id"]
    
    if len(ids_title) == 1:
        return urls_title[0], "Sprzedajemy.pl", f"Konkretna oferta: {query}"
    elif len(ids_id) == 1:
        return urls_id[0], "Sprzedajemy.pl", f"Konkretna oferta: {query}"
    elif len(ids_title) > 0 or len(ids_id) > 0:
        if len(ids_title) > len(ids_id):
            return sprzedajemy_result["url_title"], "Sprzedajemy.pl", f"Lista ofert: {query}"
        else:
            return sprzedajemy_result["url_id"], "Sprzedajemy.pl", f"Lista ofert: {query}"
    elif allegro_result and allegro_result["link"]:
        return allegro_result["link"], "Allegro", f"Wyszukiwanie Allegro: {query}"
    else:
        base = query.strip().replace(" ", "+")
        result = analyze_search(base)
        return result["url_title"], "Sprzedajemy.pl", f"Wyszukiwanie: {query}"

# üåê KONFIGURACJA
st.set_page_config(
    layout="wide", 
    page_title="OS-CAR - System Ofert", 
    page_icon="üöó"
)

# üé® STYL - ZAKTUALIZOWANY
st.markdown("""
    <style>
    .main-header {
        font-size: 2.5rem;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 0.5rem;
        font-weight: bold;
        padding-top: 0.2rem;
    }
    .search-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-bottom: 1.5rem;
    }
    .search-box h3 {
        color: white;
        margin-bottom: 1rem;
    }
    .stats-mini {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
    }
    .stats-number {
        font-size: 1.2rem;
        font-weight: bold;
    }
    .stats-label {
        font-size: 0.7rem;
        opacity: 0.9;
    }
    .date-section {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 0.8rem;
        font-family: 'Courier New', monospace;
    }
    .shipping-section {
        background-color: #f0f8f0;
        padding: 1rem;
        border-radius: 10px;
        border-left: 5px solid #28a745;
        margin-bottom: 0.8rem;
        border: 1px solid #28a745;
    }
    .secondary-box {
        background-color: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    .manual-box {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        margin-bottom: 1rem;
    }
    .allegro-blue-button {
        background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%) !important;
        color: white !important;
        font-weight: bold !important;
        border: none !important;
    }
    .allegro-blue-button:hover {
        background: linear-gradient(135deg, #1976D2 0%, #00B0FF 100%) !important;
    }
    .compact-section {
        margin-bottom: 0.5rem;
    }
    .compact-button {
        margin-bottom: 0.3rem;
    }
    .sidebar-content {
        max-height: 85vh;
        overflow-y: auto;
        padding-right: 5px;
    }
    .sidebar-content::-webkit-scrollbar {
        width: 6px;
    }
    .sidebar-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .sidebar-content::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    .sidebar-content::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    </style>
""", unsafe_allow_html=True)

# üöó NAG≈Å√ìWEK
st.markdown('<div class="main-header">üöó System OS-CAR</div>', unsafe_allow_html=True)

# INICJALIZACJA STANU - ODDZIELNE DLA WYSZUKIWARKI I RƒòCZNEGO DODAWANIA
if 'search_query' not in st.session_state:
    st.session_state.search_query = ""
if 'last_query' not in st.session_state:
    st.session_state.last_query = ""
if 'link_opened' not in st.session_state:
    st.session_state.link_opened = False

# ODDZIELNE STANY DLA FORMULARZA RƒòCZNEGO
if 'manual_id' not in st.session_state:
    st.session_state.manual_id = ""
if 'manual_link' not in st.session_state:
    st.session_state.manual_link = ""
if 'manual_note' not in st.session_state:
    st.session_state.manual_note = ""

df = load_data()

# üìä SIDEBAR - ZOPTYMALIZOWANY I KOMPAKTOWY
with st.sidebar:
    st.markdown('<div class="sidebar-content">', unsafe_allow_html=True)
    
    # ‚úÖ DATA I DZIE≈É TYGODNIA PO POLSKU (BEZ ZEGARKA)
    days_pl = {
        'Monday': 'Poniedzia≈Çek', 'Tuesday': 'Wtorek', 'Wednesday': '≈öroda',
        'Thursday': 'Czwartek', 'Friday': 'PiƒÖtek', 'Saturday': 'Sobota', 'Sunday': 'Niedziela'
    }
    day_en = datetime.now().strftime("%A")
    day_pl = days_pl.get(day_en, day_en)
    current_date = datetime.now().strftime(f"%Y-%m-%d | {day_pl}")
    
    st.markdown(f"""
        <div class="date-section">
            <div style="font-size: 1.2rem; font-weight: bold;">{current_date}</div>
        </div>
    """, unsafe_allow_html=True)
    
    # ‚úÖ SZYBKI DOSTƒòP - NAJWA≈ªNIEJSZE NA G√ìRZE
    st.markdown("### üîó Szybki Dostƒôp")
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("üè† Sprzedajemy.pl", use_container_width=True, key="sprzedajemy_btn"):
            webbrowser.open_new_tab("https://oscar.sprzedajemy.pl/")
            st.success("Otwieram Sprzedajemy.pl...")
    with col2:
        if st.button("üõí allegro.pl", use_container_width=True, key="allegro_btn"):
            webbrowser.open_new_tab("https://salescenter.allegro.com/my-assortment?limit=20&publication.status=ACTIVE&sellingMode.format=BUY_NOW&context.marketplace=allegro-pl")
            st.success("Otwieram Allegro...")
    
    if st.button("üìã Zam√≥wienia allegro", use_container_width=True, key="zamowienia_btn"):
        webbrowser.open_new_tab("https://salescenter.allegro.com/orders")
        st.success("Otwieram zam√≥wienia...")
    
    if st.button("üìä Ovoko", use_container_width=True, key="ovoko_btn"):
        webbrowser.open_new_tab("https://oscar.rrr.lt/v2")
        st.success("Otwieram Ovoko...")
    
    if st.button("üîß Polcar", use_container_width=True, key="polcar_btn"):
        webbrowser.open_new_tab("https://catalog.polcar.com/polcar")
        st.success("Otwieram Polcar...")
    
    if st.button("üßæ Wystaw fakture", use_container_width=True, key="faktura_btn"):
        webbrowser.open_new_tab("https://kontakt-oscar.fakturownia.pl/")
        st.success("Otwieram fakturowniƒô...")
    
    if st.button("üì¶ BaseLinker", use_container_width=True, key="baselinker_btn"):
        webbrowser.open_new_tab("https://panel-f.baselinker.com/index.php")
        st.success("Otwieram BaseLinker...")
    
    st.markdown("---")
    
    # ‚úÖ WYSY≈ÅKI - WY≈ªEJ
    st.markdown("### üöö Wysy≈Çki")
    st.markdown('<div class="shipping-section">', unsafe_allow_html=True)
    
    col_s1, col_s2 = st.columns(2)
    with col_s1:
        if st.button("üì¶ DHL", use_container_width=True, key="dhl_btn"):
            webbrowser.open_new_tab("https://dhl24.com.pl/pl/uzytkownik/zaloguj.html")
            st.success("Otwieram DHL...")
    with col_s2:
        if st.button("üöö AmbroExpress", use_container_width=True, key="ambro_btn"):
            webbrowser.open_new_tab("https://ambro.opennet.pl/Default.aspx")
            st.success("Otwieram AmbroExpress...")
    
    col_s3, col_s4 = st.columns(2)
    with col_s3:
        if st.button("üìÆ BLpaczka", use_container_width=True, key="blpaczka_btn"):
            webbrowser.open_new_tab("https://blpaczka.com/panel")
            st.success("Otwieram BLpaczka...")
    with col_s4:
        if st.button("üì¶ Sendit", use_container_width=True, key="sendit_btn"):
            webbrowser.open_new_tab("https://panel.sendit.pl/logowanie")
            st.success("Otwieram Sendit...")
    
    col_s5, col_s6 = st.columns(2)
    with col_s5:
        if st.button("üì¶ Polkurier", use_container_width=True, key="polkurier_btn"):
            webbrowser.open_new_tab("https://www.polkurier.pl/logowanie")
            st.success("Otwieram Polkurier...")
    with col_s6:
        if st.button("üöõ CTL Group", use_container_width=True, key="ctl_btn"):
            webbrowser.open_new_tab("https://www.ctlgroup.pl/customers/login")
            st.success("Otwieram CTL Group...")
    
    st.markdown('</div>', unsafe_allow_html=True)
    
    st.markdown("---")
    if st.button("üîÑ Od≈õwie≈º Dane", use_container_width=True, key="refresh_btn"):
        load_data.clear()
        st.rerun()
    
    st.markdown('</div>', unsafe_allow_html=True)

# üéØ G≈Å√ìWNY INTERFEJS - PROPORCJE 60%/40%
col1, col2 = st.columns([1.5, 1])  # ‚úÖ 60% WYSZUKIWARKA, 40% BAZA

# üîç PANEL WYSZUKIWANIA - 60%
with col1:
    st.markdown('<div class="search-box">', unsafe_allow_html=True)
    st.markdown("### üîç Wyszukiwarka Ofert")
    
    search_input = st.text_input(
        "**Wpisz nazwƒô czƒô≈õci, numer OEM lub ID:**",
        placeholder="np: maska skoda octavia, 5J0853661, lusterko fabia...",
        key="search_input_widget"
    )
    
    if search_input.strip():
        st.session_state.search_query = search_input.strip()

    if st.session_state.search_query and st.session_state.search_query != st.session_state.last_query:
        st.session_state.link_opened = False
        st.session_state.last_query = st.session_state.search_query

    if st.session_state.search_query:
        with st.spinner("üîÑ Szukam ofert..."):
            current_search_results = search_multiple_platforms(st.session_state.search_query)
        
        sprzedajemy_result = current_search_results["sprzedajemy"]
        ids_title, urls_title = sprzedajemy_result["ids_title"], sprzedajemy_result["urls_title"]
        ids_id, urls_id = sprzedajemy_result["ids_id"], sprzedajemy_result["urls_id"]

        st.markdown(f"#### üìã Sprzedajemy.pl")
        st.markdown(f"**Znalezione oferty:** Tytu≈Çy ({len(ids_title)}) | Numery ({len(ids_id)})")
        
        link_to_open = None
        if not ids_title and not ids_id:
            st.warning("‚ùå Brak ofert dla podanej frazy")
        elif ids_title != ids_id:
            if len(ids_title) == 1:
                st.success("üéØ Znaleziono 1 ofertƒô")
                link_to_open = urls_title[0]
            elif len(ids_id) == 1:
                st.success("üéØ Znaleziono 1 ofertƒô po numerze")
                link_to_open = urls_id[0]
            elif len(ids_title) > len(ids_id):
                st.success("üìñ Otw√≥rz listƒô ofert z tytu≈Ç√≥w")
                link_to_open = sprzedajemy_result["url_title"]
            else:
                st.success("üî¢ Otw√≥rz listƒô ofert z numer√≥w")
                link_to_open = sprzedajemy_result["url_id"]
        else:
            st.info(f"üìä Oferty znalezione: {ids_title[:3]}")
            link_to_open = sprzedajemy_result["url_title"]

        # ‚úÖ PRZYCISK ZAMIAST AUTOMATYCZNEGO OTWIERANIA
        if link_to_open:
            if st.button("üåê OTW√ìRZ OFERTƒò SPRZEDAJEMY.PL", use_container_width=True, key=f"open_sprzedajemy_{int(time.time())}"):
                webbrowser.open_new_tab(link_to_open)
                st.success("‚úÖ Otwieram ofertƒô...")

        allegro_result = current_search_results["allegro"]
        if allegro_result:
            st.markdown(f"#### üõí allegro.pl")
            st.markdown(f"**Gotowe wyszukiwanie:** Twoje oferty z filtrem")
            
            # ‚úÖ PRZYCISK ALLEGRO
            if st.button("üöÄ OTW√ìRZ ALLEGRO", key="open_allegro", use_container_width=True):
                webbrowser.open_new_tab(allegro_result['link'])
                st.success("‚úÖ Otwieram allegro.pl...")

    if st.session_state.search_query:
        if st.button("‚ûï DODAJ DO BAZY JAKO SPRZEDANE", 
                     use_container_width=True, 
                     type="primary",
                     key="add_offer_btn"):
            
            now = datetime.now().strftime("%Y-%m-%d %H:%M")
            
            with st.spinner("üîÑ Sprawdzam oferty..."):
                fresh_results = search_multiple_platforms(st.session_state.search_query)
            
            if fresh_results:
                offer_url, platform, opis = get_best_offer_link(fresh_results, st.session_state.search_query)
                
                new_row = {
                    "id": f"{platform.lower().replace('.', '')}-{st.session_state.search_query}-{int(time.time())}",
                    "tytul": f"{st.session_state.search_query}",
                    "cena": "",
                    "link": offer_url,
                    "opis": opis,
                    "status": f"Sprzedana ({now})",
                    "notatka": "",
                    "dodano": now
                }
                current_df = load_data()
                new_df = pd.DataFrame([new_row])
                updated_df = pd.concat([current_df, new_df], ignore_index=True)
                save_data(updated_df)
                st.success(f"‚úÖ Dodano jako sprzedane ({platform})!")
                st.rerun()
    
    st.markdown('</div>', unsafe_allow_html=True)
    
    # üì§ DODAWANIE RƒòCZNE
    st.markdown('<div class="manual-box">', unsafe_allow_html=True)
    st.markdown("### üìù Dodaj rƒôcznie sprzedanƒÖ czƒô≈õƒá")
    
    manual_id = st.text_input(
        "üè∑Ô∏è **Numer oferty/czƒô≈õci:**", 
        placeholder="np: 5J0853661, maska octavia...",
        key="manual_id_input",
        value=st.session_state.manual_id
    )
    
    manual_link = st.text_input(
        "üîó **Link do oferty (opcjonalnie):**", 
        placeholder="https://...",
        key="manual_link_input",
        value=st.session_state.manual_link
    )
    
    manual_note = st.text_area(
        "üìù **Notatka (opcjonalnie):**", 
        placeholder="Dodatkowe informacje...", 
        height=80,
        key="manual_note_input",
        value=st.session_state.manual_note
    )
    
    if st.button("‚úÖ DODAJ DO SPRZEDANYCH", 
                 use_container_width=True, 
                 type="primary",
                 key="manual_submit_btn"):
        
        if manual_id and manual_id.strip():
            now = datetime.now().strftime("%Y-%m-%d %H:%M")
            new_row = {
                "id": f"manual-{manual_id.strip()}-{int(time.time())}",
                "tytul": manual_id.strip(),
                "cena": "",
                "link": manual_link.strip() if manual_link else "",
                "opis": f"Rƒôcznie dodana oferta: {manual_id.strip()}",
                "status": f"Sprzedana ({now})",
                "notatka": manual_note.strip() if manual_note else "",
                "dodano": now
            }
            current_df = load_data()
            new_df = pd.DataFrame([new_row])
            updated_df = pd.concat([current_df, new_df], ignore_index=True)
            save_data(updated_df)
            
            st.session_state.manual_id = ""
            st.session_state.manual_link = ""
            st.session_state.manual_note = ""
            
            st.success("üéâ Oferta dodana do bazy sprzedanych!")
            time.sleep(0.5)
            st.rerun()
        else:
            st.error("‚ùå Wpisz numer oferty/czƒô≈õci!")
    
    st.markdown('</div>', unsafe_allow_html=True)

# üì¶ PANEL SPRZEDANYCH OFERT - 40% (LEPSZA CZYTELNO≈öƒÜ)
with col2:
    # ‚úÖ MINIMALNE STATYSTYKI NAD BAZƒÑ
    st.markdown("### üì¶ Baza Sprzedanych Ofert")
    
    if not df.empty:
        col_stat1, col_stat2 = st.columns(2)
        with col_stat1:
            st.markdown(f"""
                <div class="stats-mini">
                    <div class="stats-number">{len(df)}</div>
                    <div class="stats-label">≈ÅƒÖcznie ofert</div>
                </div>
            """, unsafe_allow_html=True)
        with col_stat2:
            # ‚úÖ DODANA DOK≈ÅADNA GODZINA OSTATNIEJ OFERTY
            last_added = df['dodano'].max()
            last_time = last_added[:16] if len(last_added) >= 16 else last_added
            st.markdown(f"""
                <div class="stats-mini">
                    <div class="stats-number">{last_time}</div>
                    <div class="stats-label">Ostatnia</div>
                </div>
            """, unsafe_allow_html=True)
    
    st.markdown('<div class="secondary-box">', unsafe_allow_html=True)
    
    if df.empty:
        st.info("üì≠ Brak ofert w bazie. Dodaj pierwszƒÖ ofertƒô u≈ºywajƒÖc formularza po lewej.")
    else:
        sort_option = st.selectbox("Sortuj:", ["Najnowsze", "Najstarsze", "Alfabetycznie"], key="sort_sold")
        
        filtered_df = df.copy()
        
        if sort_option == "Najnowsze":
            filtered_df = filtered_df.sort_values('dodano', ascending=False)
        elif sort_option == "Najstarsze":
            filtered_df = filtered_df.sort_values('dodano', ascending=True)
        else:
            filtered_df = filtered_df.sort_values('tytul', ascending=True)
        
        # ‚úÖ KOMPAKTOWY WIDOK OFERT
        for idx, row in filtered_df.iterrows():
            platform = "Sprzedajemy.pl"
            if "allegro" in str(row["id"]).lower() or "allegro" in str(row["link"]).lower():
                platform = "Allegro"
            elif "sprzedajemy" in str(row["id"]).lower():
                platform = "Sprzedajemy.pl"
            elif "manual" in str(row["id"]).lower():
                platform = "Rƒôczna"
            
            # ‚úÖ SKR√ìCONY TYTU≈Å DLA LEPSZEJ CZYTELNO≈öCI
            short_title = row['tytul'][:35] + "..." if len(row['tytul']) > 35 else row['tytul']
            
            with st.expander(f"üì¶ {short_title} [{platform}]", expanded=False):
                col_info, col_actions = st.columns([3, 1])
                
                with col_info:
                    title_key = f"title_{idx}"
                    link_key = f"link_{idx}"
                    note_key = f"note_{idx}"
                    
                    st.text_input("**Numer oferty:**", value=row["tytul"], key=title_key, 
                                on_change=lambda i=idx, k=title_key: save_field(i, k, "tytul"))
                    
                    st.text_input("**Link do oferty:**", value=row["link"], key=link_key,
                                on_change=lambda i=idx, k=link_key: save_field(i, k, "link"))
                    
                    # ‚úÖ PRZYCISK ZAMIAST LINK_BUTTON
                    if isinstance(row["link"], str) and row["link"].startswith("http"):
                        if st.button("üîó OTW√ìRZ OFERTƒò", key=f"open_offer_{idx}", use_container_width=True):
                            webbrowser.open_new_tab(row["link"])
                            st.success("Otwieram...")
                    else:
                        st.caption("üîó Brak linku")
                    
                    st.text_area("**Notatka:**", value=row["notatka"], key=note_key, height=80,
                               on_change=lambda i=idx, k=note_key: save_field(i, k, "notatka"))
                    
                    st.caption(f"üïí Dodano: {row['dodano']} | Platforma: {platform}")
                
                with col_actions:
                    st.write("")
                    if st.button("üóëÔ∏è Usu≈Ñ", key=f"del_{idx}", use_container_width=True):
                        current_df = load_data()
                        updated_df = current_df.drop(idx).reset_index(drop=True)
                        save_data(updated_df)
                        st.success("üóëÔ∏è Oferta usuniƒôta!")
                        st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

st.markdown("---")
st.markdown("""
    <div style='text-align: center; color: #666; font-size: 0.9rem;'>
        üöó <b>System OS-CAR</b> | Proste ‚Ä¢ Skuteczne ‚Ä¢ Niezawodne
    </div>
""", unsafe_allow_html=True)
